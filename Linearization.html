<title>Linearization</title>
<link rel="icon" type="image/x-icon" href="Images/Linearization/LazzyIzzi.jpg"> 
<h1>Linearization</h1> 
<h3>Requires ImageJ 1.53k or higher,  CT_Tools_Lib.jar</h3>

<h2><a href="index.html" target="_self"><em><strong>Home</strong></em></a></h2>

<h3>A pair of plugins for model-based correction of cupping beam hardening artifact in reconstructed CT slices by linearization. The first plugin calibrates against an an idealized model of the slice. The second applies the calibration to the original sinogram.</h3>

<h3>Single Material specimens</h3>

<p>Beam hardening and linearization are briefly described in the <a href="CtScannerSetup.html" target="_self">CT Scanner Setup</a> page.  Finding and applying the polynomial coefficients usually requires "penetrameter" calibration standards. In contrast, these plugins use knowledge of the specimen composition to build a "model" that is used as the standard. A known material positioned on the axis of rotation is used to <a href="XrayLookup.html" target="_self">look-up</a>  the effective energy. Assuming sufficient view angle sampling, the set of rays passing through this unique position must pass through all specimen points represented as pixels in the reconstructed image, i.e. the linear attenuation on the axis of rotation in the reconstructed image arises from the effective energy for the entire sample.  If a known material is not on the axis or a internal standard cannot be placed at that position then these plugins will not return accurate results. </p>

<h3>Multi-Material specimens</h3>

<p>Quantitative correction of beam hardening in multi-material specimens with high Z contrast is more complicated and various solutions are described in the literature<sup>1</sup>. Generally, the attenuations measured from each material in the image will not be consistent with a single effective energy and the image may contain streak artifacts. In addition to linearization post-processing, it may be possible to reduce attenuation errors and artifacts by using additional filtration. For now I'll just discuss the plugins.</p>

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/Linearization/BereaFilterStudy.png" width="600" />
<figcaption><strong> Copper 0.005cm Filtered Sandstone Reconstructions  Uncorrected(left) Linearized(right) </strong></figcaption></figure></center>

<h3>The plugins</h3>
 
<p>The first "finder" plugin combines the three steps, building a model, comparing the model to the beam hardened image, and fitting the comparision to several candidate polynomials, into one dialog. If needed, the plugins for the individual steps are described <a href="#BadThresholds">here</a>, and a graphical description of the workflow is <a href="#Workflow">here</a>.

<h3 id="Combined"></h3>

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/Linearization/Find_BH_Corrections.png" width="250" />
<figcaption><strong>The first plugin is the Linear Coefficient Finder</strong></figcaption></figure></center>

<ol>
	<li>Click on the reconstructed slice that you want to fix to make it the active window. slices must have pixel sizes in cm and pixel values in cm<sup>-1</sup></li>
	<li>Select an small region in a known material at or close to the axis of rotation and measure the observed attenuation. This group of pixels is unique since the values are obtained from the average energy of all rays passing through the portion of the specimen at the axis of rotation.</li>
	<li>Use the <a href="XrayLookup.html" target="_self">Lookup</a> plugin in this package to obtain the effective energy.</li>
	<li>Select "Find Beam Hardening Corrections" plugin in the ImageJ plugins menu. A blank image will appear next to the active window.</li>
	<li>Select a specimen material from the Materials List.</li>
	<li>Use the slider to threshold select the material in the active window. If the beam hardening is too severe to properly threshold a material an additional set of steps is described <a href="#BadThresholds">below</a>.</li>
	<li>Click the "Add Material to Tag Image" to add the material to the model. Continue until all of the materials are tagged.  Untagged materials are set to 0, "empty space" in the model image.</li>
	<li>Enter the x-ray energy found in step 3 in the Est keV Field and Click OK.</li>
</ol>

<p>The "Finder" will output a plot of the model vs image attenuations and a list of several polynomial fits to the plot data.  </p>

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/Linearization/LinearizationPlot.png" width="600" />
<figcaption><strong>Linearization "Finder" Output</strong></figcaption></figure></center>

<p>The "Add Fit" in the Plot window's Data menu can be used to examine the appropriateness of the fits listed in the "Fit Params" table. Leave the Fit Params window open for use in the "Apply" plugin.</p> 

<p>The second "apply" plugin corrects the original sinogram using the selected polynomial coefficients.</p>

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/Linearization/LinearizationApply.png" width="250" />
<figcaption><strong>Linearization "Apply" Dialog</strong></figcaption></figure></center>

<ol>
	<li>Open or Click on the sinogram used to make the reconstructed slice. </li>
	<li>In the ImageJ plugins menu select the "Apply Linearization" plugin.</li>
	<li>Select the fit you want to apply(the Fit Params table must be the active table).</li>
	<li>Click OK to apply the fit to the sinogram.</li>
	<li>Reconstruct the sinogram again to see the results.</li>
</ol>

<h3 id="BadThresholds">Correcting Severe Beam Hardening</h3>
<p>The plugins below, left to right, are the individual steps in the "finder" dialog described above.</p>
<center><figure class="easyimage easyimage-full"><img alt="" src="Images/Linearization/BH_Tools_All.png" width="700" />
<figcaption><strong>Linearization Plugins</strong></figcaption></figure></center>


<p>When proper thresholding cannot resolve the materials in the image, a rough approximation of the model slice can be used to reduce the cupping so that thresholding is possible.</p>
Start with the <a href="#Combined">Finder</a> plugin
<ol>
	<li>Select a small region in a known material at or close to the axis of rotation and measure the observed attenuation. This group of pixels is unique since the values represent the average energy of all rays passing through the sample.
	<li>Use the <a href="XrayLookup.html" target="_self">Lookup</a> plugin in this package to obtain the effective energy.</li>	
	<li>In the combined "finder" dialog, use a threshold that selects the specimen(do not include empty spaces) and tag it with a single material, either the main component or some approximation.</li>
	<li>Enter the effective keV and click OK</li>	
	<li>Apply the corrections to the image's sinogram and reconstruct. The cupping should be substantially reduced but the attenuations will be grossly in error.</li>
</ol>
Switching to the individual plugins:
<ol>
	<li>Use the "Material Tagger" plugin and the slice from step 5 above to create a properly segmented tag image.</li>
	<li>Use the Find Beam Hardening Corrections plugin. Select the original beam-hardened reconstruction and the model image from step 1. Enter the keV from step 4 above. Click OK </li>
	<li>Choose the best fit and apply it to the original sinogram.</li>
</ol>


<p>The "Material Tagger" plugin is a blunt instrument compared to far more sophisticated pixel classifiers available to ImageJ. It is a place-holder until a material tagger that uses more advanced classifiers is written.</p>

<h3 id="Workflow">Beam Hardening Correction Work Flow</h3>
<p>The workflow for correcting beam hardening artifacts using these plugins.
<ol>
	<li>The sinogram(b) is obtained experimentally or by creating a sinogram using one of the <a href="CTsimulator.html" target="_self">bremsstrahlung projector</a> plugins on a digital image(a).</li>
	<li>The reconstruction(c) is obtained using a 3rd party reconstruction application<sup>2</sup>.</li>
	<li>The model slice(d) is obtained using the tagger and the converter.</li>
	<li>The plot(e) and fits(f) are obtained using Fitter.</li>
	<li>The corrected sinogram(g) is obtained using Apply.</li>
	<li>The corrected reconstruction(h) is obtained using the 3rd party reconstruction application.</li>
</ol>

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/Linearization/BeamHardeningCorrection.png" width="700" />
<figcaption><strong>Linearization Workflow</strong></figcaption></figure></center>


<p><small>1. For example, "Beam Hardening Correction in X-ray Computed Tomography: A Comparison of Two Iterative Model-based Reconstruction Methods", K. Dremel et al., Proceedings of the 11th European Conference on Non-Destructive Testing, October 6-10, Prague, Czech Republic. Or Google "X-ray beam hardening correction".</small>
<p><small>2. The reconstructions on this page were made using Fourier inversion of parallel projections.</small>

<h2><a href="index.html" target="_self"><em><strong>Home</strong></em></a></h2>

