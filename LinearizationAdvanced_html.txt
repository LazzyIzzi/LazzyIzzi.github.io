<title>Linearization</title>
<link rel="icon" type="image/x-icon" href="Images/Index/LazzyIzzi.jpg">

<h1>Linearization</h1> 
<h3>Requires ImageJ 1.53k or higher,  MuMassCalculatorLib.jar</h3>
<h3>This page is under construction.</h3> 
<h2><a href="index.html" target="_self"><em><strong>Home</strong></em></a></h2>

<h3>A pair of plugins<sup>1</sup> for model-based correction of cupping beam hardening artifact in reconstructed CT slices by linearization. The first plugin calibrates against an an idealized model of the slice. The second applies the calibration to the original sinogram.</h3>

<h3>Single Material specimens</h3>

<p>Beam hardening and linearization are briefly described in the <a href="CtScannerSetup.html" target="_self">CT Scanner Setup</a> page.  Finding and applying the polynomial coefficients usually requires "penetrameter" calibration standards. In contrast, these plugins use knowledge of the specimen composition to build a "model" that is used as the standard. A known material positioned on the axis of rotation is used to <a href="XrayLookup.html" target="_self">look-up</a>  the effective energy. Assuming sufficient view angle sampling, the set of rays passing through this unique position must pass through all specimen points represented as pixels in the reconstructed image, i.e. the linear attenuation on the axis of rotation in the reconstructed image arises from the effective energy for the entire sample.  If a known material is not on the axis or a internal standard cannot be placed at that position then these plugins will not return accurate results. </p>

<h3>Multi-Material specimens</h3>

<p>Quantitative correction of beam hardening in multi-material specimens with high Z contrast is more complex and various solutions are described in the literature<sup>2</sup>. It is sometimes possible to significantly reduce attenuation errors and streak artifacts in reconstructed slices by adding more filtration than that needed for successful correction of cupping artifact using linearization.</p>

<p>The contrast between different materials can change with x-ray energy. This property is used in <a href="https://en.wikipedia.org/wiki/Dual-energy_X-ray_absorptiometry" target="_blank">DEXA</a> to separate bone from soft tissue. In CT, thinner portions of the specimen have lower effective energies.  Linearization fixes the cupping beam hardening artifact but does not change the fact that different materials will reconstruct at slightly different energies. Monochromatic x-ray sources like those obtained at a synchrotron(there is actually a small bandwidth &#916;E/E) produce images without detectable beam hardening(it's there but it is way below the noise). So how monochromatic must an x-ray source be to reduce the energy dependent contrast change to below measurable limits?</p>

<p>If there are two known materials, like calcite and quartz in a sandstone, and streak artifacts are not significant, then the x-ray energy obtained from the contrast ratios between the two can be compared to the energies obtained from the separate linear attenuations. If the energies are the same within acceptable limits then the filtration is sufficient.

<p>In the example below, the attenuations of calcite(solid blue) and quartz(solid red) and calcite/quartz(solid gray) are calculated from NIST data and material densities. An observed calcite/quartz linear attenuation ratio of 1.6(dashed red line) indicates an energy of 55.4keV(brown vertical line). The attenuations of calcite and quartz at 55.4 keV are 1.18cm<sup>-1</sup> and 0.74cm<sup>-1</sup> respectively.  If the calculated and observed values for calcite and quartz do not agree within acceptable limits, then the x-ray source is not sufficiently monochromatic. The example calculation is sensitive in the 30-100keV range.

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/Calcite-QuartzRatioPlot.png" width="500" />
<figcaption><strong>Comparing Two Attenuations to Their Ratio</strong></figcaption></figure></center>

<p>Below are two simulated images of berea sandstone containing quartz grains(gray) and calcite cements(white).  The images are from a series  created using a 160KV x-ray source with copper filters from 0.005cm to 0.08cm thickness.</p>

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/BereaFilterStudy.png" width="600" />
<figcaption><strong>Berea Sandstone Reconstructions 0.005cm Copper filtered Uncorrected(left) and 0.08cm Corrected(right) </strong></figcaption></figure></center>

<p>The cupping in the 0.005cm filtered image is easily corrected by linearization. Cupping is not visible in the 0.08cm filtered image. An actual thin filter CT scan will be much faster because of the higher count rate. The resulting image will require linearization during reconstruction and the finished slice will be easy to segment into calcite and quartz.There will be a small error in the attenuation of the calcite.</p>

<p>Partial correction of attenuation errors and reduction of streak artifacts in high Z contrast specimens can be obtained by additional filtering. Unfortunately, the method of comparing direct and indirect effective energies described above to determine the degree of correction is compromised by the streaks. In the simulation below the calcite(CaCO<sub>3</sub>) has been replaced by siderite(FeCO<sub>3</sub>). Streaking remains in the region around the siderite cements after linearization.</p>

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/SideriteCu005HCorr.png" width="300" />
<figcaption><strong>Siderite Sandstone Reconstructions 0.005cm Linearized</strong></figcaption></figure></center>

 <p>In this simulation, additional filtration reduced both the streak artifact and attenuation errors. The sequence below shows the error in attenuation with increasing filter thickness.  <a href="CTsimulator.html" target="_self">bremsstrahlung projectors</a>.</p> 
 
<center><figure class="easyimage easyimage-full"><img alt="" src="Images/QuartzSideriteMuLinError.gif" width="300" />
<figcaption><strong>Digital Sandstone Hi Z Component attenuation error reduced by filtering</strong></figcaption></figure></center>

<p>The plots below show the reduction of cupping artifact(left) and attenuation error(right) for the series of filter thicknesses. The cupping was measured using the center to edge attenuation change.</p>  The attenuation error was obtained by:
<ol>
	<li>Look-up the effective energies for the calcite and the center and edge quartz attenuations</li>
	<li>averaging the quartz energies </li>
	<li>calculating the percent error of the calcite energy with respect to the calcite energy</li>	
</ol>


<center><figure class="easyimage easyimage-full"><img alt="" src="Images/FilterStudyPlots.png" width="800" />
<figcaption><strong>Filtering Vs Cupping(left) and Filtering Vs Attenuation error(right) </strong></figcaption></figure></center>

<p>Note: This is an unpublished method that has not seen peer review. Your comments to LazzyIzzi@gmail.com are appreciated.</p>

<h3>The plugins</h3>
 
<p>The first "finder" plugin combines the first three steps, building a model, comparing the model to the beam hardened image, and fitting the comparision to several candidate polynomials, into one dialog. If needed, the plugins for the individual steps are described <a href="#BadThresholds">here</a>, and a graphical description of the workflow is <a href="#Workflow">here</a>.

<h3 id="Combined"></h3>

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/Find_BH_Corrections.png" width="250" />
<figcaption><strong>The first plugin is the Linear Coefficient Finder</strong></figcaption></figure></center>



<ol>
	<li>Click on the reconstructed slice that you want to fix to make it the active window. slices must have pixel sizes in cm and pixel values in cm<sup>-1</sup></li>
	<li>Select an small region in a known material at or close to the axis of rotation and measure the observed attenuation. This group of pixels is unique since the values are obtained from the average energy of all rays passing through the portion of the specimen at the axis of rotation.
	<li>Use the <a href="XrayLookup.html" target="_self">Lookup</a> plugin in this package to obtain the effective energy.</li>
	<li>Select "Find Beam Hardening Corrections" plugin in the ImageJ plugins menu. A blank image will appear next to the active window.</li>
	<li>Select a specimen material from the Materials List.</li>
	<li>Use the slider to threshold select the material in the active window. If the beam hardening is too severe to properly threshold a material an additional set of steps is described <a href="#BadThresholds">below</a>.</li>
	<li>Click the "Add Material to Tag Image" to add the material to the model. Continue until all of the materials are tagged.  Untagged materials are set to 0, "empty space" in the model image.</li>
	<li>Enter the x-ray energy found in step 3 in the Est keV Field and Click OK.</li>
</ol>

<p>The "Finder" will output two windows</p>

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/LinearizationPlot.png" width="600" />
<figcaption><strong>Linearization "Finder" Output</strong></figcaption></figure></center>

<p>The "Add Fit" in the Plot window's Data menu can be used to examine the appropriateness of the fits listed in the "Fit Params" table.</p> 
<p>The second "apply" plugin corrects the original sinogram using the selected polynomial coefficients.</p>

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/LinearizationApply.png" width="250" />
<figcaption><strong>Linearization "Apply" Dialog</strong></figcaption></figure></center>

<ol>
	<li>Open or Click on the sinogram used to make the reconstructed slice. </li>
	<li>In the ImageJ plugins menu select the "Apply Linearization" plugin.</li>
	<li>Select the fit you want to apply(the Fit Params table must be the active table).</li>
	<li>Click OK to apply the fit to the sinogram.</li>
	<li>Reconstruct the sinogram again to see the results.</li>
</ol>

<h3 id="BadThresholds">Correcting Severe Beam Hardening</h3>
<p>The plugins below, left to right, are the individual steps in the "finder" dialog described above.
<center><figure class="easyimage easyimage-full"><img alt="" src="Images/BH_Tools_All.png" width="700" />
<figcaption><strong><center>Linearization Plugins</center></strong></figcaption></figure></center>
</p>

<p>When proper thresholding cannot resolve the materials in the image, a rough approximation of the model slice can be used to reduce the beam hardening artifact.</p>
Start with <a href="#Combined">combined</a> plugin
<ol>
	<li>Select a small region in a known material at or close to the axis of rotation and measure the observed attenuation. This group of pixels is unique since the values represent the average energy of all rays passing through the sample.
	<li>Use the <a href="XrayLookup.html" target="_self">Lookup</a> plugin in this package to obtain the effective energy.</li>	
	<li>In the combined "finder" dialog, use a threshold that selects the specimen(do not include empty spaces) and tag it with a single material, either the main component or some approximation.</li>
	<li>Enter the effective keV and click OK</li>	
	<li>Apply the corrections to the image's sinogram and reconstruct. The cupping should be substantially reduced but the attenuations will be grossly in error.</li>
</ol>
Switching to the individual plugins:
<ol>
	<li>Use the "Material Tagger" plugin and the slice from step 5 above to create a properly segmented tag image.</li>
	<li>Use the Find Beam Hardening Corrections plugin. Select the original beam-hardened reconstruction and the model image from step 1. Enter the keV from step 4 above. Click OK </li>
	<li>Choose the best fit and apply it to the original sinogram.</li>
</ol>


<p>The "Material Tagger" plugin is a blunt instrument compared to far more sophisticated pixel classifiers available to ImageJ. It is a place-holder until a material tagger that uses more advanced classifiers is written.</p>

<h3 id="Workflow">Beam Hardening Correction Work Flow</h3>
<p>The workflow for correcting beam hardening artifacts using these plugins.
<ol>
	<li>The sinogram(b) is obtained experimentally or by creating a sinogram using one of the <a href="CTsimulator.html" target="_self">bremsstrahlung projector</a> plugins on a digital image(a).</li>
	<li>The reconstruction(c) is obtained using a 3rd party reconstruction application<sup>2</sup>.</li>
	<li>The model slice(d) is obtained using the tagger and the converter.</li>
	<li>The plot(e) and fits(f) are obtained using Fitter.</li>
	<li>The corrected sinogram(g) is obtained using Apply.</li>
	<li>The corrected reconstruction(h) is obtained using the 3rd party reconstruction application.</li>
</ol>

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/BeamHardeningCorrection.png" width="700" />
<figcaption><strong><center>Linearization Workflow</center></strong></figcaption></figure></center>

<p><small>1. The plugins on this page implement my preferred method for finding and applying linearization corrections to sinogram data. They evolved from the ideas I learned at a poster session many years ago. I would cite it here if I could recall the author. That process involved many iterations. My plugins are single pass. They arose from the need to obtain quantitative concentrations of fluids in rock specimens.  The specimens were usually in pressure vessels and were scanned with an instrument optimized for much smaller samples. So beam hardening was always an issue. These plugins worked well for these samples.  I hope they work as well for yours.</small>
<p><small>2. For example, "Beam Hardening Correction in X-ray Computed Tomography: A Comparison of Two Iterative Model-based Reconstruction Methods", K. Dremel et al., Proceedings of the 11th European Conference on Non-Destructive Testing, October 6-10, Prague, Czech Republic. Or Google "X-ray beam hardening correction".</small>
<p><small>3. The reconstructions on this page were made using Fourier inversion of parallel projections.</small>

<h2><a href="index.html" target="_self"><em><strong>Home</strong></em></a></h2>

