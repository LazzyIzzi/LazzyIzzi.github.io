<title>CT Scanner Setup</title>
<link rel="icon" type="image/x-icon" href="Images/Index/LazzyIzzi.jpg">
<h1>CT Scanner Setup</h1> 
<h3>Requires ImageJ 1.53k or higher,  MuMassCalculatorLib.jar</h3> 
<h2><a href="index.html" target="_self"><em><strong>Home</strong></em></a></h2>

<h4>Scanner Setup  is a 1-D attenuation model that displays x-ray intensity distributions at important points along the ray path.  The plugin provides a non-modal dialog to aid in selecting optimal CT scanner operating conditions to improve signal-to-noise and reduce beam hardening artifact.</h4>
<center><figure class="easyimage easyimage-full"><img alt="" src="Images/ScannerSetup/ScannerSchematicSideView791.png" width="700" />
<figcaption><strong>Schematic of a typical radiography/tomography experimental setup</strong></figcaption></figure></center>

<p>The above figure shows a schematic of a simple radiography or CT scanner. The arrow widths indicate spectral width and the length indicates intensity. </p>

<h3>What is Beam Hardening?</h3>

<p>Beam hardening is the shifting of the broad spectrum of a conventional x-ray source toward higher average (hard) energies as it passes through a material.&nbsp;Lower energy (longer wavelength) X-rays are preferentially attenuated leaving the higher energy, more penetrating X-rays for detection. It is mostly evident in the photoelectric energy range where the attenuation of materials changes rapidly with photon energy. The plot below illustrates this energy shift (plotted as wavelength for dramatic effect) caused by the beam passing through different thicknesses of copper.</p>


<center><figure class="easyimage easyimage-full"><img alt="" src="Images/ScannerSetup/EffectiveEnergySourceFilters.png" width="500" />
<figcaption><strong><center>Source intensity distribution with copper filters</center></strong></figcaption></figure></center>


<p> When measuring attenuation of a specimen using a conventional bremsstrahlung x-ray source, we first measure the incident beam intensity "<em>I<sub>0</sub></em>". Then we put a specimen in the beam and repeat the measurement "<em>I</em> ".  We know the thickness of the specimen so we can calculate the linear attenuation <big><em>&mu;&rho;</em></big> using the equation.

<center><figure class="easyimage easyimage-full"><strong><img alt="" src="Images/ScannerSetup/AttenuationEqn.png" width="300" /> </strong></figure></center>

 With <big><em>&mu;&rho;</em></big> in hand and if we know the the specimen's composition we can <a href="XrayLookupMuLin.html" target="_self">look-up</a> the "<em>Effective</em>" x-ray energy of the incident x-ray beam.
<br>
<br> Definition: The Effective Energy is the monochromatic x-ray energy that will produce the same attenuation as that measured with a given polychromatic x-ray energy distribution.
<br>
<br>But the distribution is changing as it passes through the specimen!  So we try again with a thinner specimen and sure enough, we get a different effective energy. The plot below shows the use of different thickness copper filters to remove a portion of the low-energy (soft) x-rays incident on different thickness aluminum specimens. Unfiltered(red), the effective energy changes from about 45keV in the 0.01cm specimen to 72keV for the 2.5cm thick one. By removing the soft x-rays from the incident beam with a 0.1cm copper filter the average energy shifts to about 90keV and remains nearly constant for all thicknesses of of aluminum.

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/ScannerSetup/EffectiveEnergyBeamHardening.png" width="500" />
<figcaption><strong>Pre-hardening using filters</strong></figcaption></figure></center>

<h3>Why is Beam Hardening Important?</h3>
<p>Beam Hardening results in an over-estimate of attenuation by shorter paths through the specimen.&nbsp; It produces the well-known cupping and streak artifacts in reconstructed tomographic images. Cupping makes the image brighter at the thinner edges, streaks appear as brighter regions between more x-ray absorbing higher atomic number features in the specimen(streaks can also be caused by non-linear detector response).</p>
<center><figure class="easyimage easyimage-full"><img alt="" src="Images/ScannerSetup/CuppingImage.png" width="256" />
<figcaption><strong>Cupping Artifact in a Simulated Sandstone<br> Calcite cement Z contrast is not sufficient to cause detectable streaks.</strong></figcaption></figure></center>

<h3>What can be done to reduce Beam Hardening?</h3>
<p> Apart from absorption edges, beam hardening is always present, lower energy x-rays are more strongly absorbed. But we can reduce the effect, hopefully below detection, by experimental technique and post-processing.</p>

<ol type="1">
	<li>Pre-harden the X-ray beam using a filter, usually a metal foil, located at the X-ray source. This can result in a substantial loss of x-ray intensity. If not already at maximum, the x-ray source current can be increased to offset the loss. Occasionally the accelerating potential of the X-ray source is increased to offset the decreased intensity caused by the filter absorbance. This is usually not a good idea. It raises the effective energy and lowers the sample attenuation an may result in additional noise in reconstructed slices.</li>
	<li>Apply a correction to the observed attenuations so that a plot of attenuation vs sample thickness becomes linear. The linearization function is usually a polynomial that is determined, depending on the information being sought, either by simply observing the quality of the corrected images or by careful calibration. Linearization is most successful when the sample is relatively homogeneous, i.e. when all rays passing through the sample see about the same average composition. We will discuss linearization <a href="Linearization.html" target="_self"><em>here</em></a>. After correction by linearization the reconstructed image linear attenuations will be at a single effective energy. When samples are not relatively homogeneous, more advanced methods beyond the current scope of my plugins are required.</li>
</ol>


<h3>The ImageJ plugin</h3>
<p>The <strong>Scanner Setup</strong> plugin helps to fine-tune the pre-hardening technique. It guides selection of the operating conditions that will give good contrast and accurate attenuation measurements for your sample. It provides an interactive way to minimize the severity of beam hardening. <em><strong>Scanner Setup</strong> is not a predictor of scanner performance.  The x-ray source intensity is calculated using the Kramers equation and neglects characteristic emission lines and source configuration.  The detector is "ideal" in that it returns at each energy the fraction of counts absorbed by the scintillator screen. Energy dependent fluorescent yield, collection efficiency, gain and other characteristics of real detectors are neglected.</em></p>


<h3>The User Interface</h3>
<center><figure class="easyimage easyimage-full"><img alt="" src="Images/ScannerSetup/BHworkbenchInitial.png" width="700" />
<figcaption><strong>ImageJ Plugin CT Scanner Setup, Initial</strong></figcaption></figure></center>
<ul>
<li>Target - The anode material of a conventional X-ray source.</li>
<li>KV - The accelerating potential of a conventional X-ray source.</li>
<li>ma - The beam current of a conventional X-ray source.</li>
<li>Filter Material - Usually a metal foil placed just downstream of the X-ray source.</li>
<li>Filter Thickness(cm) - The thickness of the filter in centimeters.</li>
<li>Sample Name Filter - Clips the choices to those beginning with the characters in this textbox. Clear to restore the full list.</li>
<li>Sample Name Choices -Pick a material from this list imported from <a href="MaterialsEditor.html" target="_self">DefaultMaterials.csv</a> in the plugins/DialogData folder.</li>
<li>Sample Formula - Pre-populated from the name choice. Edit to change the formula.</li>
<li>Sample Thickness(cm) - Pre-populated from the name choice. Edit to change the formula.</li>
<li>Sample Density(gm/cc) - Pre-populated from the name choice. Edit to change the formula.</li>
<li>Detector Name Filter - Clips the choices to those beginning with the characters in this textbox. Clear to restore the full list.</li>
<li>Detector Name Choices -Pick a material from this list.</li>
<li>Detector Formula - Pre-populated from the name choice. Edit to change the formula.</li>
<li>Detector Thickness(cm) - Pre-populated from the name choice. Edit to change the formula.</li>
<li>Detector Density(gm/cc) - Pre-populated from the name choice. Edit to change the formula.</li>
<li>Plot Minimum(keV) - Sets the X-ray Spectra plot minimum energy. The maximum energy is the accelerating potential(KV).</li>
<li>Plot Inc(keV - Sets the energy step size for the polychromatic scan. Large steps go faster. Small steps have better spectral resolution.</li>
<li>keV Angstroms Buttons - Selects the plot x-axis scale</li>
<li>Update Plot - Recalculate the plots and results.</li>
<li>OK - Recalculate,  update and exit leaving plot and results windows open</li>
<li>Cancel - Exit closing plots and results windows.</li>
<li>Help -  Brings up this page.</li>
</ul>

<h3>Example</h3>

<h3>Step 1, Initial setup</h3>
<ul>Using the pull-down formulas menu or manual entry:
	<li>Configure the X-ray source and detector. The detector is "ideal", modeled by counting photons absorbed by a screen of the user-supplied composition, thickness, and density. The detector configuration can significantly alter the high-energy x-ray response. Real detectors vary considerably in design, construction and response. Therefore, I make no attempt to model photon yield, collection efficiency, amplification, digitization etc.</li>
	<li>Replace the Sample values with your sample's average composition and density. The formula is entered as atom1:count1:atom2:count2....</li>
	<li>Click the <strong>Update Plot</strong> to create/update the three results windows(right).</li>
</ul>

<p>The top plot shows the relationship between sample thickness and attenuation. It should look like a nearly straight line if the incident photon beam is approximately monochromatic.</p>
<p>The middle plot shows intensity vs X-ray energy at five sampling points along the beam path.
<ul>
	<li> Blue,   the source spectrum.</li>
	<li> Red,    the source spectrum after the filter.</li>
	<li> Green,  the source spectrum after the filter and sample.</li>
	<li> Gray,   source spectrum after the filter detected.  "Io"</li>
	<li> Black,  the source spectrum after the filter and sample detected. "I"</li>
</ul>
</p>
<p>The window at the bottom shows the results for each trial configuration.</p>

<h3>Step 2, Evaluating the initial set-up</h3>

In the BH Workbench Results window:
<ul>
	<li>The sample attenuation <q>S Tau</q>, the product of <big><em>&mu;&rho;x</em></big>, is 2.58, it has been shown that it <a href="https://doi.org/10.1016/0167-5087(83)90393-9" target="_blank">should be &cong; 2</a> to obtain the best S/N in the shortest amount of time.</li>
	<li>The beam hardening <q>BH%</q> is 28%, ideally it should be &lt;10%.</li>
	<li>The "Photon Use", the percent of the number of source counts measured by the  detector, is 15.4%</li>
</ul>
Moving down stream and looking at the X-ray Spectra we see:
<ul>
	<li>The source(blue) emits a broad spectrum of photons from just below 160 KeV, peaking at 80KeV and falling off at lower energies.</li>
	<li>The filter(red) reduces the low energies but still transmits a large fraction of photons below 50 KeV.</li>
	<li>The detected filter spectrum(gray) is heavily low-energy weighted due to poor detector performance at high energies. Most of the high energy x-rays pass directly through the 0.01cm thick Cesium Iodide scintillator. Note that the detected filter spectrum contains features from the detector's Cesium and Iodine absorbance edge jumps.</li>
	<li>The sample(green) does not transmit any of the filtered photons less than 50KeV.</li>
	<li>The detected(black) sample spectrum has no photons less than 50KeV</li>
</ul>
Conclusion: The  pre-hardening by a 0.01cm copper filter is not sufficient. When we measure the incident intensity without the sample in the beam <q><em><strong>Io</strong></em></q> we are counting many low energy photons that will be completely absorbed by the thicker portions of the specimen but will be transmitted by the thinner regions. This causes significant beam hardening as seen in the  Attenuation vs Thickness curve. We need to increase the thickness of the filter to some optimal value.

<h3>Step 3, Optimization<sup>1</sup></h3>

Add filter thickness and observe the changes in the curves. Removing the low energy X-rays will:
<ul>
	<li>Raise the effective energy (Eeff in the results window).  </li>
	<li>Lower the sample attenuation. If reduced too far you may want to lower the Source KV</li>
	<li>Reduce the beam hardening.</li>
	<li>Reduce the photon use, increasing exposure time.</li>
</ul>
Achieving a proper balance between photon use and acceptable beam hardening often depends on the sample composition and structure, the effectiveness of post-acquisition beam hardening corrections, and the information to be obtained from the image.

<center><figure class="easyimage easyimage-full"><img alt="" src="Images/ScannerSetup/BHworkbenchFinal.png" width="700" />
<figcaption><strong>ImageJ Plugin Beam Hardening Workbench, Final</strong></figcaption>
</figure></center>

<h3>Step 4, Evaluating the final set-up<sup>1</sup></h3>

<ul>
	<li>The sample attenuation is now 1.989</li>
	<li>The beam hardening <q>BH%</q> is 7.4%</li>
	<li>The "Photon Use", is 9.1%</li>
	<li>The thin CsI scintillator is not a good choice. It is inefficient in the energy range transmitted by this sample.
</ul>

<p>1. My <a href="XrayCalculatorExcel.html" target="_blank"><em><strong>Excel Beam Hardening Add-in</strong></em></a> uses the <em>Solver</em> to maximize <q>Photon Use%</q> while constraining sample tau and beam hardening.</p>


<h2><a href="index.html" target="_self"><em><strong>Home</strong></em></a></h2>

